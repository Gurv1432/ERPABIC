<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tinder Clone - Live</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <style>
        /* --- CSS STYLES --- */
        :root {
            --primary-color: #ff4b6a; 
            --secondary-color: #6c757d;
            --bg-light: #f8f9fa;
            --text-dark: #212529;
            --chat-sent: #ff4b6a;
            --chat-received: #e9ecef;
            --app-height: 100vh;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        body { background-color: #e9ecef; height: var(--app-height); display: flex; justify-content: center; align-items: center; overflow: hidden; }

        /* Main App Container */
        #app-container {
            width: 100%; max-width: 414px; 
            height: 100%; background: white; position: relative;
            display: flex; flex-direction: column; box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        /* --- Header --- */
        .app-header {
            height: 60px; display: flex; align-items: center; justify-content: center;
            border-bottom: 1px solid #eee; font-weight: 600; color: var(--text-dark);
            position: relative; z-index: 10; background: white;
        }
        .loading-spinner { position: absolute; right: 15px; color: var(--primary-color); display: none; }

        /* --- Content --- */
        .app-content { flex: 1; overflow-y: auto; position: relative; padding-bottom: 60px; }
        .view-section { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: white; display: none; flex-direction: column; padding: 20px; overflow-y: auto; }
        .view-section.active { display: flex; }
        .no-padding { padding: 0; }

        /* --- Nav --- */
        .bottom-nav {
            height: 60px; border-top: 1px solid #eee; display: flex; justify-content: space-around;
            align-items: center; position: absolute; bottom: 0; width: 100%; background: white; z-index: 10;
        }
        .nav-item { color: var(--secondary-color); font-size: 1.5rem; position: relative; cursor: pointer; transition: 0.2s; }
        .nav-item.active { color: var(--primary-color); transform: scale(1.1); }
        .badge { position: absolute; top: -5px; right: -5px; background: red; color: white; font-size: 0.7rem; padding: 2px 5px; border-radius: 50%; display: none;}

        /* --- UI Components --- */
        .btn { padding: 12px; border: none; border-radius: 25px; font-weight: 600; cursor: pointer; width: 100%; transition: 0.2s; }
        .btn-primary { background: var(--primary-color); color: white; box-shadow: 0 4px 10px rgba(255, 75, 106, 0.3); }
        .btn-outline { border: 2px solid var(--secondary-color); color: var(--secondary-color); background: transparent;}
        .form-group { margin-bottom: 15px; }
        .form-input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; outline: none; }
        .form-label { font-size: 0.85rem; color: var(--secondary-color); margin-bottom: 5px; display: block; }

        /* --- Cards --- */
        .card-container { flex: 1; display: flex; justify-content: center; align-items: center; padding: 20px; position: relative; }
        .profile-card {
            width: 100%; height: 100%; max-height: 500px; border-radius: 20px; overflow: hidden;
            position: relative; box-shadow: 0 10px 20px rgba(0,0,0,0.1); background: #f0f0f0;
        }
        .card-image { width: 100%; height: 100%; object-fit: cover; }
        .card-details {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: linear-gradient(to top, rgba(0,0,0,0.9), transparent); color: white; padding: 20px;
        }
        .action-buttons { display: flex; justify-content: center; gap: 20px; margin-top: 20px; position: absolute; bottom: 30px; width: 100%; z-index: 5;}
        .action-btn {
            width: 60px; height: 60px; border-radius: 50%; border: none;
            font-size: 1.5rem; cursor: pointer; box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            display: flex; justify-content: center; align-items: center; transition: 0.2s;
        }
        .action-btn:active { transform: scale(0.9); }
        .btn-deny { background: white; color: #ff4b6a; }
        .btn-like { background: white; color: #20c997; }

        /* --- Lists --- */
        .list-item { display: flex; align-items: center; padding: 15px; border-bottom: 1px solid #f0f0f0; cursor: pointer; transition: 0.2s;}
        .list-item:hover { background: #fafafa; }
        .list-avatar { width: 50px; height: 50px; border-radius: 50%; margin-right: 15px; object-fit: cover; background: #ddd;}
        .list-info { flex: 1; }
        .list-name { font-weight: 600; font-size: 1rem; }
        .list-sub { font-size: 0.8rem; color: var(--secondary-color); }
        .request-actions { display: flex; gap: 10px; }
        .req-btn { padding: 5px 15px; border-radius: 15px; border: none; cursor: pointer; font-size: 0.8rem;}
        .req-accept { background: var(--primary-color); color: white; }

        /* --- Chat --- */
        #chat-window-view { z-index: 20; padding-bottom: 0; background: #fff; }
        .chat-header { display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #eee; background: white;}
        .back-btn { font-size: 1.2rem; margin-right: 15px; cursor: pointer; padding: 10px;}
        .chat-messages { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; background: var(--bg-light); }
        .message-bubble { max-width: 75%; padding: 10px 15px; border-radius: 18px; font-size: 0.9rem; word-wrap: break-word;}
        .msg-sent { align-self: flex-end; background: var(--chat-sent); color: white; border-bottom-right-radius: 4px; }
        .msg-received { align-self: flex-start; background: white; color: var(--text-dark); border-bottom-left-radius: 4px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .chat-input-area { padding: 10px; border-top: 1px solid #eee; display: flex; align-items: center; background: white; }
        .chat-input { flex: 1; border: none; padding: 10px; outline: none; background: #f0f0f0; border-radius: 20px; margin-right: 10px;}
        .chat-actions i { font-size: 1.3rem; color: var(--secondary-color); margin: 0 8px; cursor: pointer; }
        .chat-image-preview { max-width: 150px; border-radius: 10px; display: block; margin-top: 5px; }

        /* --- Dev & Profile --- */
        .dev-panel { background: #222; color: #eee; padding: 15px; margin-top: 20px; border-radius: 10px; display: none;}
        .dev-panel.active { display: block; }
        .profile-pic-upload { width: 110px; height: 110px; background: #eee; border-radius: 50%; margin: 0 auto 20px; position: relative; overflow: hidden; border: 3px solid white; box-shadow: 0 5px 15px rgba(0,0,0,0.1);}
        .profile-pic-upload img { width: 100%; height: 100%; object-fit: cover; }
        .upload-overlay { position: absolute; bottom: 0; width: 100%; background: rgba(0,0,0,0.5); color: white; text-align: center; font-size: 0.7rem; padding: 5px; cursor: pointer;}
        .hidden { display: none !important; }
        .centered-msg { text-align: center; color: var(--secondary-color); padding: 20px; margin-top: 50px;}
    </style>
</head>
<body>

<div id="app-container">
    <div class="app-header">
        <div id="header-title">Discover</div>
        <div class="loading-spinner" id="global-spinner"><i class="fas fa-circle-notch fa-spin"></i></div>
        <div class="location-indicator hidden" id="location-header" style="position: absolute; left: 15px;">
            <i class="fas fa-map-marker-alt"></i> <span id="user-location-span">...</span>
        </div>
    </div>

    <div class="app-content">

        <div id="signup-view" class="view-section active" style="justify-content: center;">
            <h1 style="text-align: center; margin-bottom: 10px; color: var(--primary-color); font-size: 2.5rem;">ðŸ”¥</h1>
            <h2 style="text-align: center; margin-bottom: 30px;">Tinder Clone</h2>
            <div class="form-group">
                <input type="text" id="signup-username" class="form-input" placeholder="Choose a Username">
            </div>
            <button class="btn btn-primary" onclick="handleSignup()">Create Account</button>
            <p style="text-align: center; margin-top: 20px; font-size: 0.8rem; color: #888;">
                Connected to Firebase: tinder-ce3a1
            </p>
        </div>

        <div id="profile-setup-view" class="view-section">
            <h2>Complete Profile</h2>
            <p style="margin-bottom: 20px; color: var(--secondary-color);">Let's make you look good.</p>
            <div class="profile-pic-upload" onclick="document.getElementById('profile-img-input').click()">
                <img id="profile-preview" src="https://via.placeholder.com/150?text=Upload" alt="Profile">
                <div class="upload-overlay"><i class="fas fa-camera"></i></div>
                <input type="file" id="profile-img-input" hidden accept="image/*" onchange="processImage(event, 'profile-preview')">
            </div>
            <div class="form-group">
                <label class="form-label">Full Name *</label>
                <input type="text" id="setup-name" class="form-input" placeholder="Eg. Rahul Sharma">
            </div>
             <div class="form-group">
                <label class="form-label">Location (City) *</label>
                <input type="text" id="setup-location" class="form-input" placeholder="Eg. Delhi, Mumbai">
            </div>
            <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" id="setup-email" class="form-input">
            </div>
            <div class="form-group">
                <label class="form-label">Phone</label>
                <input type="tel" id="setup-phone" class="form-input">
            </div>
            <button class="btn btn-primary" onclick="saveProfile()">Save Profile</button>
        </div>

        <div id="home-view" class="view-section no-padding">
            <div class="card-container" id="card-area">
                <div class="centered-msg">Loading people nearby...</div>
            </div>
        </div>

        <div id="requests-view" class="view-section no-padding">
            <div id="requests-list">
                <div class="centered-msg">Loading requests...</div>
            </div>
        </div>

        <div id="chat-list-view" class="view-section no-padding">
            <div id="matches-list">
               <div class="centered-msg">No matches yet. Keep swiping!</div>
            </div>
        </div>

        <div id="profile-view" class="view-section">
             <div class="profile-pic-upload">
                <img id="my-profile-pic" src="" alt="My Profile">
            </div>
            <h2 style="text-align: center;" id="my-profile-name">User</h2>
            <p style="text-align: center; color: var(--secondary-color); margin-bottom: 30px;" id="my-profile-loc">Location</p>
            <button class="btn btn-outline" style="margin-bottom: 10px;" onclick="startLogout()">Logout</button>
            <button class="btn btn-outline" style="border-color: #333; color: #333;" onclick="toggleDevMode()">Developer Panel <i class="fas fa-code"></i></button>
            <div id="dev-panel-area" class="dev-panel">
                <h3>Developer Tools</h3>
                <button class="btn btn-primary" style="margin-bottom: 10px; background: #555;" onclick="generateFakeUsers()">Generate 3 Fake Users</button>
            </div>
        </div>
    </div> 

    <div id="chat-window-view" class="view-section">
        <div class="chat-header">
            <i class="fas fa-arrow-left back-btn" onclick="closeChatWindow()"></i>
            <img id="chat-with-avatar" class="list-avatar" style="width: 35px; height: 35px; margin-right: 10px;" src="">
            <div style="font-weight: 600;" id="chat-with-name">User</div>
        </div>
        <div class="chat-messages" id="chat-messages-area"></div>
        <div class="chat-input-area">
            <input type="file" id="chat-image-input" hidden accept="image/*" onchange="processImage(event, null, sendImageMessage)">
            <input type="text" class="chat-input" id="message-input" placeholder="Type a message...">
            <div class="chat-actions">
                <i class="far fa-image" onclick="document.getElementById('chat-image-input').click()"></i>
                <i class="fas fa-paper-plane" style="color: var(--primary-color);" onclick="sendTextMessage()"></i>
            </div>
        </div>
    </div>

    <div class="bottom-nav" id="main-nav">
        <div class="nav-item active" onclick="navigateTo('home')"><i class="fas fa-fire"></i></div>
        <div class="nav-item" onclick="navigateTo('requests')">
            <i class="fas fa-heart"></i>
            <span class="badge" id="request-badge">0</span>
        </div>
        <div class="nav-item" onclick="navigateTo('chat-list')"><i class="fas fa-comment-alt"></i></div>
        <div class="nav-item" onclick="navigateTo('profile')"><i class="fas fa-user"></i></div>
    </div>
</div>

<script>
    /* --- YOUR FIREBASE CONFIGURATION (Compatible Format) --- */
    const firebaseConfig = {
      apiKey: "AIzaSyAoyQulYeas2xQWVgGg-L81jkCTU7aAozA",
      authDomain: "tinder-ce3a1.firebaseapp.com",
      databaseURL: "https://tinder-ce3a1-default-rtdb.firebaseio.com",
      projectId: "tinder-ce3a1",
      storageBucket: "tinder-ce3a1.firebasestorage.app",
      messagingSenderId: "832688331776",
      appId: "1:832688331776:web:0c78bf232fc9e10ce4cce5"
    };

    // Initialize Firebase
    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.firestore();

    /* --- GLOBAL STATE --- */
    let myId = localStorage.getItem('tinder_uid');
    let myProfile = null;
    let currentMatchId = null;
    let chatUnsubscribe = null;
    let devMode = false;

    // --- INIT ---
    window.onload = async function() {
        if(myId) {
            showSpinner(true);
            try {
                const doc = await db.collection('users').doc(myId).get();
                if(doc.exists) {
                    myProfile = doc.data();
                    if(myProfile.isProfileComplete) {
                        initApp();
                    } else {
                        navigateToSetup();
                    }
                } else {
                    localStorage.removeItem('tinder_uid');
                    showSignup();
                }
            } catch(e) {
                console.error("Firebase Connection Error:", e);
                alert("Could not connect to database. Check if Firestore is enabled in Test Mode.");
            }
            showSpinner(false);
        } else {
            showSignup();
        }
    };

    function showSpinner(show) {
        document.getElementById('global-spinner').style.display = show ? 'block' : 'none';
    }

    /* --- AUTH & SETUP --- */
    function showSignup() {
        document.getElementById('main-nav').style.display = 'none';
        document.getElementById('signup-view').classList.add('active');
    }

    async function handleSignup() {
        const username = document.getElementById('signup-username').value;
        if(!username) return alert("Enter username");
        showSpinner(true);
        try {
            const res = await db.collection('users').add({
                username: username,
                isProfileComplete: false,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            myId = res.id;
            localStorage.setItem('tinder_uid', myId);
            navigateToSetup();
        } catch(e) {
            console.error(e);
            alert("Error: Check Firebase Console -> Firestore Database -> Rules (Set to Test Mode)");
        }
        showSpinner(false);
    }

    function navigateToSetup() {
        document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active'));
        document.getElementById('profile-setup-view').classList.add('active');
    }

    let tempProfileBase64 = "https://via.placeholder.com/150";

    function processImage(event, previewId, callback = null) {
        const file = event.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = new Image();
            img.src = e.target.result;
            img.onload = function() {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const MAX_WIDTH = 500; 
                let width = img.width;
                let height = img.height;
                if (width > MAX_WIDTH) {
                    height *= MAX_WIDTH / width;
                    width = MAX_WIDTH;
                }
                canvas.width = width;
                canvas.height = height;
                ctx.drawImage(img, 0, 0, width, height);
                const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
                if(previewId) {
                    document.getElementById(previewId).src = dataUrl;
                    tempProfileBase64 = dataUrl;
                }
                if(callback) callback(dataUrl);
            }
        }
        reader.readAsDataURL(file);
    }

    async function saveProfile() {
        const name = document.getElementById('setup-name').value;
        const location = document.getElementById('setup-location').value;
        const email = document.getElementById('setup-email').value;
        const phone = document.getElementById('setup-phone').value;
        if(!name || !location) return alert("Name and Location are required!");
        showSpinner(true);
        try {
            await db.collection('users').doc(myId).update({
                name: name,
                location: location.trim(),
                locationLower: location.trim().toLowerCase(),
                email: email,
                phone: phone,
                pic: tempProfileBase64,
                isProfileComplete: true
            });
            const doc = await db.collection('users').doc(myId).get();
            myProfile = doc.data();
            initApp();
        } catch(e) {
            alert("Error saving: " + e.message);
        }
        showSpinner(false);
    }

    function initApp() {
        document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active'));
        document.getElementById('main-nav').style.display = 'flex';
        document.getElementById('location-header').classList.remove('hidden');
        document.getElementById('user-location-span').innerText = myProfile.location;
        navigateTo('home');
        listenToRequests();
    }

    function startLogout() {
        localStorage.removeItem('tinder_uid');
        location.reload();
    }

    /* --- NAVIGATION --- */
    function navigateTo(view) {
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        const titles = { 'home': 'Discover', 'requests': 'Likes', 'chat-list': 'Messages', 'profile': 'Profile' };
        document.getElementById('header-title').innerText = titles[view];
        if(view === 'home') document.querySelector('.nav-item:nth-child(1)').classList.add('active');
        if(view === 'requests') document.querySelector('.nav-item:nth-child(2)').classList.add('active');
        if(view === 'chat-list') document.querySelector('.nav-item:nth-child(3)').classList.add('active');
        if(view === 'profile') document.querySelector('.nav-item:nth-child(4)').classList.add('active');
        document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active'));
        document.getElementById(view + '-view').classList.add('active');
        if(view === 'home') loadSuggestions();
        if(view === 'requests') loadRequests();
        if(view === 'chat-list') loadMatches();
        if(view === 'profile') renderMyProfile();
    }

    /* --- LOGIC --- */
    async function loadSuggestions() {
        const cardArea = document.getElementById('card-area');
        cardArea.innerHTML = '<div class="centered-msg">Searching nearby...</div>';
        try {
            const snapshot = await db.collection('users')
                .where('locationLower', '==', myProfile.locationLower)
                .limit(50).get();
            const swipesSnap = await db.collection('swipes')
                .where('from', '==', myId).get();
            const swipedIds = new Set();
            swipesSnap.forEach(doc => swipedIds.add(doc.data().to));
            swipedIds.add(myId);
            const candidates = [];
            snapshot.forEach(doc => {
                if(!swipedIds.has(doc.id)) candidates.push({id: doc.id, ...doc.data()});
            });
            if(candidates.length === 0) {
                cardArea.innerHTML = '<div class="centered-msg">No new people around.<br><br>Tip: Use Developer Panel to generate fake users!</div>';
                return;
            }
            renderCard(candidates[0]);
        } catch(e) {
            console.error(e);
            cardArea.innerHTML = '<div class="centered-msg">Error loading suggestions.</div>';
        }
    }

    function renderCard(user) {
        const html = `
            <div class="profile-card">
                <img src="${user.pic}" class="card-image">
                <div class="card-details">
                    <h2>${user.name}</h2>
                    <p><i class="fas fa-map-marker-alt"></i> ${user.location}</p>
                </div>
            </div>
            <div class="action-buttons">
                <button class="action-btn btn-deny" onclick="handleSwipe('${user.id}', 'deny')"><i class="fas fa-times"></i></button>
                <button class="action-btn btn-like" onclick="handleSwipe('${user.id}', 'like', '${user.name}')"><i class="fas fa-heart"></i></button>
            </div>
        `;
        document.getElementById('card-area').innerHTML = html;
    }

    async function handleSwipe(targetId, type, targetName) {
        showSpinner(true);
        await db.collection('swipes').add({
            from: myId, to: targetId, type: type,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        if(type === 'like') {
            const check = await db.collection('swipes')
                .where('from', '==', targetId)
                .where('to', '==', myId)
                .where('type', '==', 'like').get();
            if(!check.empty) {
                await createMatch(targetId);
                alert(`It's a Match with ${targetName}!`);
            }
        }
        showSpinner(false);
        loadSuggestions();
    }

    async function createMatch(otherId) {
        const ids = [myId, otherId].sort();
        const matchId = ids[0] + "_" + ids[1];
        await db.collection('matches').doc(matchId).set({
            users: ids,
            lastMessage: "Matched! Say hi ðŸ‘‹",
            lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
            seenBy: [myId]
        }, { merge: true });
    }

    function listenToRequests() {
        db.collection('swipes').where('to', '==', myId).where('type', '==', 'like')
            .onSnapshot((snapshot) => {
                const badge = document.getElementById('request-badge');
                if(!snapshot.empty) {
                    badge.style.display = 'block';
                    badge.innerText = snapshot.size;
                } else { badge.style.display = 'none'; }
            });
    }

    async function loadRequests() {
        const list = document.getElementById('requests-list');
        list.innerHTML = '<div class="centered-msg">Loading...</div>';
        const likesSnap = await db.collection('swipes').where('to', '==', myId).where('type', '==', 'like').get();
        if(likesSnap.empty) { list.innerHTML = '<div class="centered-msg">No pending requests.</div>'; return; }
        const mySwipesSnap = await db.collection('swipes').where('from', '==', myId).get();
        const mySwipedIds = new Set();
        mySwipesSnap.forEach(d => mySwipedIds.add(d.data().to));
        let html = '';
        let count = 0;
        for (const doc of likesSnap.docs) {
            const senderId = doc.data().from;
            if (!mySwipedIds.has(senderId)) {
                count++;
                const userDoc = await db.collection('users').doc(senderId).get();
                if(userDoc.exists) {
                    const u = userDoc.data();
                    html += `
                        <div class="list-item">
                            <img src="${u.pic}" class="list-avatar">
                            <div class="list-info">
                                <div class="list-name">${u.name}</div>
                                <div class="list-sub">Liked you</div>
                            </div>
                            <div class="request-actions">
                                <button class="req-btn" onclick="handleSwipe('${senderId}', 'deny')">Deny</button>
                                <button class="req-btn req-accept" onclick="handleSwipe('${senderId}', 'like', '${u.name}')">Accept</button>
                            </div>
                        </div>
                    `;
                }
            }
        }
        list.innerHTML = count === 0 ? '<div class="centered-msg">No pending requests.</div>' : html;
    }

    function loadMatches() {
        const list = document.getElementById('matches-list');
        list.innerHTML = '<div class="centered-msg">Loading conversations...</div>';
        db.collection('matches').where('users', 'array-contains', myId).orderBy('lastUpdated', 'desc')
            .onSnapshot(async (snapshot) => {
                if(snapshot.empty) { list.innerHTML = '<div class="centered-msg">No matches yet.</div>'; return; }
                let html = '';
                for(const doc of snapshot.docs) {
                    const match = doc.data();
                    const matchId = doc.id;
                    const otherId = match.users.find(u => u !== myId);
                    const userDoc = await db.collection('users').doc(otherId).get();
                    if(userDoc.exists) {
                        const u = userDoc.data();
                        html += `
                            <div class="list-item" onclick="openChat('${matchId}', '${otherId}', '${u.name}', '${u.pic}')">
                                <img src="${u.pic}" class="list-avatar">
                                <div class="list-info">
                                    <div class="list-name">${u.name}</div>
                                    <div class="list-sub">${match.lastMessage}</div>
                                </div>
                            </div>
                        `;
                    }
                }
                list.innerHTML = html;
            });
    }

    function openChat(matchId, partnerId, name, pic) {
        currentMatchId = matchId;
        document.getElementById('chat-with-name').innerText = name;
        document.getElementById('chat-with-avatar').src = pic;
        document.getElementById('main-nav').style.display = 'none';
        document.getElementById('chat-window-view').classList.add('active');
        const msgArea = document.getElementById('chat-messages-area');
        msgArea.innerHTML = '';
        chatUnsubscribe = db.collection('matches').doc(matchId).collection('messages')
            .orderBy('timestamp', 'asc').onSnapshot(snapshot => {
                msgArea.innerHTML = '';
                snapshot.forEach(doc => {
                    const msg = doc.data();
                    const css = msg.sender === myId ? 'msg-sent' : 'msg-received';
                    let content = msg.text;
                    if(msg.image) content = `<img src="${msg.image}" class="chat-image-preview">`;
                    msgArea.innerHTML += `<div class="message-bubble ${css}">${content}</div>`;
                });
                msgArea.scrollTop = msgArea.scrollHeight;
            });
    }

    function closeChatWindow() {
        if(chatUnsubscribe) chatUnsubscribe();
        document.getElementById('chat-window-view').classList.remove('active');
        document.getElementById('main-nav').style.display = 'flex';
        currentMatchId = null;
    }

    async function sendTextMessage() {
        const input = document.getElementById('message-input');
        const text = input.value.trim();
        if(!text) return;
        input.value = '';
        await sendMessageToDb({
            text: text, sender: myId, timestamp: firebase.firestore.FieldValue.serverTimestamp()
        }, "Sent a message");
    }

    async function sendImageMessage(base64Img) {
         await sendMessageToDb({
            text: '', image: base64Img, sender: myId, timestamp: firebase.firestore.FieldValue.serverTimestamp()
        }, "Sent an image");
    }

    async function sendMessageToDb(msgData, summaryText) {
        if(!currentMatchId) return;
        await db.collection('matches').doc(currentMatchId).collection('messages').add(msgData);
        await db.collection('matches').doc(currentMatchId).update({
            lastMessage: summaryText, lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
        });
    }

    function renderMyProfile() {
        document.getElementById('my-profile-name').innerText = myProfile.name;
        document.getElementById('my-profile-loc').innerText = myProfile.location;
        document.getElementById('my-profile-pic').src = myProfile.pic;
    }

    function toggleDevMode() {
        devMode = !devMode;
        document.getElementById('dev-panel-area').classList.toggle('active', devMode);
    }

    async function generateFakeUsers() {
        const loc = myProfile.location;
        const names = ['Aanya', 'Priya', 'Rohan', 'Kabir'];
        for(let i=0; i<3; i++) {
            const name = names[Math.floor(Math.random() * names.length)] + " " + Math.floor(Math.random()*100);
            const gender = i % 2 === 0 ? 'women' : 'men';
            const pic = `https://randomuser.me/api/portraits/${gender}/${Math.floor(Math.random()*90)}.jpg`;
            await db.collection('users').add({
                name: name, location: loc, locationLower: loc.toLowerCase(),
                pic: pic, isProfileComplete: true, isFake: true
            });
        }
        alert(`Generated 3 fake users in ${loc}. Go to Discover tab.`);
        loadSuggestions();
    }
</script>
</body>
</html>