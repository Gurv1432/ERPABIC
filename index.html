<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MatchMe - Secure Login</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <style>
        :root {
            --primary-color: #ff4b6a; --secondary-color: #6c757d; --bg-light: #f8f9fa;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        body { background-color: #e9ecef; height: 100vh; display: flex; justify-content: center; align-items: center; overflow: hidden; }

        #app-container { width: 100%; max-width: 414px; height: 100%; background: white; position: relative; display: flex; flex-direction: column; }

        /* Auth Screen Styles */
        .auth-container { padding: 30px; display: flex; flex-direction: column; justify-content: center; height: 100%; text-align: center; }
        .auth-title { font-size: 2rem; color: var(--primary-color); margin-bottom: 10px; }
        .auth-toggle { color: var(--primary-color); cursor: pointer; font-weight: 600; margin-top: 15px; display: inline-block;}
        .error-msg { color: red; font-size: 0.8rem; margin-top: 10px; display: none; }

        /* Common UI */
        .app-header { height: 60px; display: flex; align-items: center; justify-content: center; border-bottom: 1px solid #eee; font-weight: 600; position: relative; }
        .loading-spinner { position: absolute; right: 15px; color: var(--primary-color); display: none; }
        .view-section { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: white; display: none; flex-direction: column; padding: 20px; overflow-y: auto; z-index: 5;}
        .view-section.active { display: flex; }
        .no-padding { padding: 0; }

        .btn { padding: 12px; border: none; border-radius: 25px; font-weight: 600; cursor: pointer; width: 100%; margin-top: 10px; background: var(--primary-color); color: white; }
        .form-input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; margin-bottom: 10px; outline: none; }
        
        /* Bottom Nav */
        .bottom-nav { height: 60px; border-top: 1px solid #eee; display: flex; justify-content: space-around; align-items: center; position: absolute; bottom: 0; width: 100%; background: white; z-index: 10; }
        .nav-item { color: var(--secondary-color); font-size: 1.5rem; cursor: pointer; }
        .nav-item.active { color: var(--primary-color); }

        /* Dev Panel */
        .dev-badge { background: #333; color: #fff; padding: 5px 10px; border-radius: 5px; font-size: 0.7rem; margin-top: 5px; display: inline-block;}
        .dev-panel { background: #222; color: #eee; padding: 15px; margin-top: 20px; border-radius: 10px; display: none; }
        .dev-panel.active { display: block; }

        /* Chat & Cards (Simplified CSS from previous version) */
        .card-container { flex: 1; display: flex; justify-content: center; align-items: center; padding: 20px; }
        .profile-card { width: 100%; height: 100%; max-height: 450px; border-radius: 20px; overflow: hidden; position: relative; background: #eee; }
        .card-image { width: 100%; height: 100%; object-fit: cover; }
        .card-details { position: absolute; bottom: 0; width: 100%; background: rgba(0,0,0,0.6); color: white; padding: 20px; }
        .action-buttons { display: flex; justify-content: center; gap: 20px; margin-top: 20px; }
        .action-btn { width: 60px; height: 60px; border-radius: 50%; border: none; font-size: 1.5rem; cursor: pointer; box-shadow: 0 5px 10px rgba(0,0,0,0.1); }
        .btn-deny { background: white; color: red; } .btn-like { background: white; color: green; }

        /* Chat Window */
        #chat-window-view { z-index: 20; }
        .chat-messages { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; background: #f8f9fa; }
        .message-bubble { padding: 10px 15px; border-radius: 15px; max-width: 75%; font-size: 0.9rem; }
        .msg-sent { align-self: flex-end; background: var(--primary-color); color: white; }
        .msg-received { align-self: flex-start; background: white; border: 1px solid #ddd; }
        .chat-input-area { padding: 10px; border-top: 1px solid #eee; display: flex; gap: 10px; }
        
        .hidden { display: none !important; }
        .centered-msg { text-align: center; color: #888; margin-top: 50px; }
    </style>
</head>
<body>

<div id="app-container">
    
    <div class="app-header" id="main-header" style="display: none;">
        <span id="header-title">Discover</span>
        <div class="loading-spinner" id="global-spinner"><i class="fas fa-circle-notch fa-spin"></i></div>
    </div>

    <div id="auth-view" class="view-section active" style="z-index: 100;">
        <div class="auth-container">
            <h1 class="auth-title">MatchMe</h1>
            <p id="auth-subtitle">Login to continue</p>
            
            <div style="margin-top: 30px;">
                <input type="email" id="auth-email" class="form-input" placeholder="Email Address">
                <input type="password" id="auth-password" class="form-input" placeholder="Password">
                
                <button class="btn" id="auth-btn" onclick="handleLogin()">Login</button>
                <div class="error-msg" id="auth-error"></div>
                
                <p style="margin-top: 20px; font-size: 0.9rem;">
                    <span id="toggle-text">New here?</span> 
                    <span class="auth-toggle" onclick="toggleAuthMode()">Create Account</span>
                </p>
            </div>
            
            <div style="margin-top: 40px; border-top: 1px solid #eee; padding-top: 20px;">
                <p style="font-size: 0.8rem; color: #888;">For Developers:</p>
                <p style="font-size: 0.75rem; color: #aaa;">Login with <b>admin@test.com</b> to access developer tools.</p>
            </div>
        </div>
    </div>

    <div id="setup-view" class="view-section">
        <h2>Setup Profile</h2>
        <p style="color: #666; margin-bottom: 20px;">Complete your details to start.</p>
        <input type="file" id="profile-upload" accept="image/*" class="form-input">
        <input type="text" id="setup-name" class="form-input" placeholder="Full Name">
        <input type="text" id="setup-city" class="form-input" placeholder="City (e.g. Delhi)">
        <button class="btn" onclick="saveProfile()">Save & Continue</button>
    </div>

    <div id="home-view" class="view-section no-padding">
        <div class="card-container" id="card-area">
            <div class="centered-msg">Loading...</div>
        </div>
    </div>

    <div id="chat-list-view" class="view-section no-padding">
        <div id="matches-list" style="padding-top: 10px;"></div>
    </div>

    <div id="profile-view" class="view-section">
        <div style="text-align: center;">
            <img id="my-pic" src="" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover;">
            <h2 id="my-name">User</h2>
            <p id="my-city" style="color: #666;">Location</p>
            
            <div id="admin-badge-area" style="display:none;">
                <span class="dev-badge">ADMIN / DEVELOPER</span>
            </div>

            <button class="btn" style="background: #333; margin-top: 20px;" onclick="handleLogout()">Logout</button>
            
            <button id="dev-btn" class="btn" style="background: #555; display: none;" onclick="document.getElementById('dev-panel').classList.toggle('active')">
                Open Developer Tools
            </button>
            
            <div id="dev-panel" class="dev-panel">
                <h3>Developer Console</h3>
                <p style="font-size: 0.8rem; color: #aaa;">Generate fake data for testing.</p>
                <button class="btn" style="background: #444; border: 1px solid #666;" onclick="generateFakeUsers()">+ Generate 3 Users in My City</button>
            </div>
        </div>
    </div>

    <div id="chat-window-view" class="view-section">
        <div class="app-header" style="justify-content: flex-start; padding: 0 15px;">
            <i class="fas fa-arrow-left" onclick="closeChat()" style="font-size: 1.2rem; cursor: pointer; padding: 10px;"></i>
            <span id="chat-partner-name" style="margin-left: 10px;">User</span>
        </div>
        <div class="chat-messages" id="chat-msgs"></div>
        <div class="chat-input-area">
            <input type="text" id="msg-input" class="form-input" style="margin:0;" placeholder="Type...">
            <button class="btn" style="width: 60px; margin:0;" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>

    <div class="bottom-nav" id="main-nav" style="display: none;">
        <div class="nav-item active" onclick="navTo('home')"><i class="fas fa-fire"></i></div>
        <div class="nav-item" onclick="navTo('chat-list')"><i class="fas fa-comment-alt"></i></div>
        <div class="nav-item" onclick="navTo('profile')"><i class="fas fa-user"></i></div>
    </div>

</div>

<script>
    // --- FIREBASE CONFIG (ADD YOUR KEYS HERE) ---
    const firebaseConfig = {
      apiKey: "AIzaSyAoyQulYeas2xQWVgGg-L81jkCTU7aAozA",
      authDomain: "tinder-ce3a1.firebaseapp.com",
      databaseURL: "https://tinder-ce3a1-default-rtdb.firebaseio.com",
      projectId: "tinder-ce3a1",
      storageBucket: "tinder-ce3a1.firebasestorage.app",
      messagingSenderId: "832688331776",
      appId: "1:832688331776:web:0c78bf232fc9e10ce4cce5"
    };

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // --- STATE ---
    let currentUser = null;
    let userData = null;
    let isSignupMode = false;
    let currentChatId = null;

    // --- AUTH LOGIC ---
    auth.onAuthStateChanged(async (user) => {
        if (user) {
            currentUser = user;
            // Check if profile exists in DB
            const doc = await db.collection('users').doc(user.uid).get();
            if (doc.exists) {
                userData = doc.data();
                startApp();
            } else {
                // New user, show setup
                showView('setup');
            }
        } else {
            // No user, show Login
            currentUser = null;
            userData = null;
            document.getElementById('main-nav').style.display = 'none';
            document.getElementById('main-header').style.display = 'none';
            showView('auth');
        }
    });

    function toggleAuthMode() {
        isSignupMode = !isSignupMode;
        document.getElementById('auth-title').innerText = isSignupMode ? "Create Account" : "MatchMe";
        document.getElementById('auth-subtitle').innerText = isSignupMode ? "Sign up to find matches" : "Login to continue";
        document.getElementById('auth-btn').innerText = isSignupMode ? "Sign Up" : "Login";
        document.getElementById('toggle-text').innerText = isSignupMode ? "Already have an account?" : "New here?";
        document.querySelector('.auth-toggle').innerText = isSignupMode ? "Login" : "Create Account";
        document.getElementById('auth-error').style.display = 'none';
    }

    function handleLogin() {
        const email = document.getElementById('auth-email').value;
        const pass = document.getElementById('auth-password').value;
        const errorDiv = document.getElementById('auth-error');

        if(!email || !pass) {
            errorDiv.innerText = "Please fill all fields";
            errorDiv.style.display = 'block';
            return;
        }

        errorDiv.style.display = 'none';
        
        if (isSignupMode) {
            auth.createUserWithEmailAndPassword(email, pass)
                .catch(err => { errorDiv.innerText = err.message; errorDiv.style.display = 'block'; });
        } else {
            auth.signInWithEmailAndPassword(email, pass)
                .catch(err => { errorDiv.innerText = err.message; errorDiv.style.display = 'block'; });
        }
    }

    function handleLogout() {
        auth.signOut();
        location.reload();
    }

    // --- SETUP & PROFILE ---
    async function saveProfile() {
        const name = document.getElementById('setup-name').value;
        const city = document.getElementById('setup-city').value;
        // Simplified image handling (using placeholder if none selected)
        const file = document.getElementById('profile-upload').files[0];
        
        if(!name || !city) return alert("Name and City required");

        let picUrl = "https://via.placeholder.com/150";
        
        // Base64 logic for prototype
        if(file) {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = async function () {
                picUrl = reader.result; 
                await pushProfile(name, city, picUrl);
            };
        } else {
            await pushProfile(name, city, picUrl);
        }
    }

    async function pushProfile(name, city, pic) {
        await db.collection('users').doc(currentUser.uid).set({
            name: name,
            location: city,
            locationLower: city.toLowerCase(),
            pic: pic,
            email: currentUser.email,
            isAdmin: currentUser.email === "admin@test.com" // üîê SECRET DEV LOGIC
        });
        location.reload();
    }

    // --- APP NAVIGATION ---
    function startApp() {
        document.getElementById('main-nav').style.display = 'flex';
        document.getElementById('main-header').style.display = 'flex';
        renderProfilePage();
        navTo('home');
    }

    function showView(viewId) {
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
        document.getElementById(viewId + '-view').classList.add('active');
    }

    function navTo(page) {
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        // Simple active state toggle
        if(page === 'home') document.querySelector('.nav-item:nth-child(1)').classList.add('active');
        if(page === 'chat-list') document.querySelector('.nav-item:nth-child(2)').classList.add('active');
        if(page === 'profile') document.querySelector('.nav-item:nth-child(3)').classList.add('active');

        if(page === 'home') loadCards();
        if(page === 'chat-list') loadChats();
        
        showView(page);
    }

    // --- MAIN FEATURES ---
    async function loadCards() {
        const container = document.getElementById('card-area');
        container.innerHTML = "Loading...";
        
        // Get users in same city, excluding self
        const snap = await db.collection('users')
            .where('locationLower', '==', userData.locationLower)
            .limit(20).get();
            
        let found = false;
        container.innerHTML = "";

        snap.forEach(doc => {
            if(doc.id !== currentUser.uid) {
                const u = doc.data();
                // Check if already swiped logic skipped for brevity in auth-focus code
                const card = `
                    <div class="profile-card">
                        <img src="${u.pic}" class="card-image">
                        <div class="card-details">
                            <h3>${u.name}</h3>
                            <p>${u.location}</p>
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button class="action-btn btn-like" onclick="doLike('${doc.id}', '${u.name}')">‚ù§Ô∏è</button>
                    </div>
                `;
                container.innerHTML = card; // Showing 1 card stack style
                found = true;
            }
        });
        
        if(!found) container.innerHTML = `<div class="centered-msg">No one new in ${userData.location}.<br>Try Developer Mode!</div>`;
    }

    async function doLike(targetId, name) {
        // Create Match immediately for demo
        const ids = [currentUser.uid, targetId].sort();
        const matchId = ids.join('_');
        
        await db.collection('matches').doc(matchId).set({
            users: ids,
            updated: firebase.firestore.FieldValue.serverTimestamp(),
            lastMsg: "Matched!"
        }, { merge: true });
        
        alert("Matched with " + name);
        loadCards();
    }

    // --- CHAT ---
    function loadChats() {
        const list = document.getElementById('matches-list');
        list.innerHTML = "Loading chats...";
        
        db.collection('matches').where('users', 'array-contains', currentUser.uid)
            .onSnapshot(snap => {
                let html = "";
                snap.forEach(doc => {
                    const data = doc.data();
                    const otherId = data.users.find(id => id !== currentUser.uid);
                    html += `<div style="padding:15px; border-bottom:1px solid #eee; cursor:pointer;" onclick="openChat('${doc.id}', '${otherId}')">
                                <b>Chat with User</b><br><small>${data.lastMsg}</small>
                             </div>`;
                });
                list.innerHTML = html || "<div class='centered-msg'>No matches yet</div>";
            });
    }

    function openChat(matchId, otherId) {
        currentChatId = matchId;
        showView('chat-window');
        const msgArea = document.getElementById('chat-msgs');
        
        db.collection('matches').doc(matchId).collection('messages')
            .orderBy('ts').onSnapshot(snap => {
                msgArea.innerHTML = "";
                snap.forEach(doc => {
                    const m = doc.data();
                    const cls = m.by === currentUser.uid ? 'msg-sent' : 'msg-received';
                    msgArea.innerHTML += `<div class="message-bubble ${cls}">${m.txt}</div>`;
                });
            });
    }

    function closeChat() { showView('chat-list'); }

    function sendMessage() {
        const txt = document.getElementById('msg-input').value;
        if(!txt) return;
        document.getElementById('msg-input').value = "";
        
        db.collection('matches').doc(currentChatId).collection('messages').add({
            txt: txt, by: currentUser.uid, ts: firebase.firestore.FieldValue.serverTimestamp()
        });
        db.collection('matches').doc(currentChatId).update({ lastMsg: txt });
    }

    // --- DEVELOPER / PROFILE ---
    function renderProfilePage() {
        document.getElementById('my-name').innerText = userData.name;
        document.getElementById('my-city').innerText = userData.location;
        document.getElementById('my-pic').src = userData.pic;

        // üîê ADMIN CHECK
        if(userData.isAdmin) {
            document.getElementById('admin-badge-area').style.display = 'block';
            document.getElementById('dev-btn').style.display = 'block';
        } else {
            document.getElementById('admin-badge-area').style.display = 'none';
            document.getElementById('dev-btn').style.display = 'none';
        }
    }

    async function generateFakeUsers() {
        const names = ["Riya", "Arjun", "Sneha", "Vikram"];
        const loc = userData.location;
        
        for(let n of names) {
            await db.collection('users').add({
                name: n + " (Bot)",
                location: loc,
                locationLower: loc.toLowerCase(),
                pic: "https://via.placeholder.com/150",
                email: "fake@bot.com",
                isAdmin: false
            });
        }
        alert("3 Fake Users added in " + loc);
    }
</script>
</body>
</html>